{"version":3,"sources":["../src/CoverageTransformer.js"],"names":["sourceMapRegEx","CoverageTransformer","options","basePath","warn","console","exclude","fileName","indexOf","match","useAbsolutePaths","readJSON","filePath","existsSync","Error","JSON","parse","readFileSync","readFile","sourceStore","sources","sparceCoverageCollector","fileCoverage","codeIsArray","codeFromFile","jsText","code","Array","isArray","join","exec","sourceMapDir","dirname","rawSourceMap","inputSourceMap","Buffer","toString","sourceMapPath","String","split","error","setCoverage","map","srcPath","substr","resolve","sourceMap","inlineSourceMap","origSourceFilename","origFileName","sourcesContent","extname","file","replace","sourceRoot","forEach","source","idx","setSourceCode","set","resolvePath","resolvedSource","relative","process","cwd","getMappingResolved","location","mapping","Object","assign","keys","branchMap","index","genItem","hits","b","info","updateBranch","srcItem","fnMap","f","updateFunction","statementMap","s","updateStatement","loc","srcCoverage","getFinalCoverage","getPath","absolutePath","fullSourceMapPath","path","item","addFileCoverage","collector","add","filter","reduce","obj","name"],"mappings":"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","file":"CoverageTransformer.js","sourcesContent":["import { Collector } from '../utils/node!istanbul';\nimport path from '../utils/node!path';\nimport fs from '../utils/node!fs';\nimport { SourceMapConsumer } from '../utils/node!source-map';\nimport SparceCoverageCollector from './SparceCoverageCollector';\nimport getMapping from './getMapping';\nimport remapFunction from './remapFunction';\nimport remapBranch from './remapBranch';\n\nconst sourceMapRegEx = /(?:\\/{2}[#@]{1,2}|\\/\\*)\\s+sourceMappingURL\\s*=\\s*(data:(?:[^;]+;)+base64,)?(\\S+)/;\n\nexport default class CoverageTransformer {\n\tconstructor(options) {\n\t\tthis.basePath = options.basePath;\n\t\tthis.warn = options.warn || console.warn;\n\n\t\tthis.exclude = () => false;\n\t\tif (options.exclude) {\n\t\t\tif (typeof options.exclude === 'function') {\n\t\t\t\tthis.exclude = options.exclude;\n\t\t\t} else if (typeof options.exclude === 'string') {\n\t\t\t\tthis.exclude = (fileName) => fileName.indexOf(options.exclude) > -1;\n\t\t\t} else {\n\t\t\t\tthis.exclude = (fileName) => fileName.match(options.exclude);\n\t\t\t}\n\t\t}\n\n\t\tthis.useAbsolutePaths = !!options.useAbsolutePaths;\n\n\t\tthis.readJSON = options.readJSON\n\t\t\t|| function readJSON(filePath) {\n\t\t\t\tif (!fs.existsSync(filePath)) {\n\t\t\t\t\tthis.warn(Error(`Could not find file: \"${filePath}\"`));\n\t\t\t\t\treturn null;\n\t\t\t\t}\n\t\t\t\treturn JSON.parse(fs.readFileSync(filePath));\n\t\t\t};\n\n\t\tthis.readFile = options.readFile\n\t\t\t|| function readFile(filePath) {\n\t\t\t\tif (!fs.existsSync(filePath)) {\n\t\t\t\t\tthis.warn(new Error(`Could not find file: \"${filePath}\"`));\n\t\t\t\t\treturn '';\n\t\t\t\t}\n\t\t\t\treturn fs.readFileSync(filePath);\n\t\t\t};\n\n\t\tthis.sourceStore = options.sources;\n\n\t\tthis.sparceCoverageCollector = new SparceCoverageCollector();\n\t}\n\n\taddFileCoverage(filePath, fileCoverage) {\n\t\tif (this.exclude(filePath)) {\n\t\t\tthis.warn(`Excluding: \"${filePath}\"`);\n\t\t\treturn;\n\t\t}\n\n\t\t/* coverage.json can sometimes include the code inline */\n\t\tlet codeIsArray = true;\n\t\tlet codeFromFile = false;\n\t\tlet jsText = fileCoverage.code;\n\t\tif (!jsText) {\n\t\t\tjsText = this.readFile(filePath);\n\t\t\tcodeFromFile = true;\n\t\t}\n\t\tif (Array.isArray(jsText)) { /* sometimes the source is an array */\n\t\t\tjsText = jsText.join('\\n');\n\t\t} else {\n\t\t\tcodeIsArray = false;\n\t\t}\n\t\tlet match = sourceMapRegEx.exec(jsText);\n\t\tlet sourceMapDir = path.dirname(filePath);\n\t\tlet rawSourceMap;\n\n\t\tif (fileCoverage.inputSourceMap) {\n\t\t\trawSourceMap = fileCoverage.inputSourceMap;\n\t\t} else if (!match && !codeFromFile) {\n\t\t\tcodeIsArray = false;\n\t\t\tjsText = this.readFile(filePath);\n\t\t\tmatch = sourceMapRegEx.exec(jsText);\n\t\t}\n\n\t\tif (match) {\n\t\t\tif (match[1]) {\n\t\t\t\trawSourceMap = JSON.parse((new Buffer(match[2], 'base64').toString('utf8')));\n\t\t\t} else {\n\t\t\t\tconst sourceMapPath = path.join(sourceMapDir, match[2]);\n\t\t\t\trawSourceMap = this.readJSON(sourceMapPath);\n\t\t\t\tsourceMapDir = path.dirname(sourceMapPath);\n\t\t\t}\n\t\t}\n\n\t\tif (!rawSourceMap) {\n\t\t\t/* We couldn't find a source map, so will copy coverage after warning. */\n\t\t\tthis.warn(new Error(`Could not find source map for: \"${filePath}\"`));\n\t\t\ttry {\n\t\t\t\tfileCoverage.code = String(fs.readFileSync(filePath)).split('\\n');\n\t\t\t} catch (error) {\n\t\t\t\tthis.warn(new Error(`Could find source for : \"${filePath}\"`));\n\t\t\t}\n\t\t\tthis.sparceCoverageCollector.setCoverage(filePath, fileCoverage);\n\t\t\treturn;\n\t\t}\n\n\t\tsourceMapDir = this.basePath || sourceMapDir;\n\n\t\t// replace relative paths in source maps with absolute\n\t\trawSourceMap.sources = rawSourceMap.sources.map((srcPath) => (\n\t\t\tsrcPath.substr(0, 1) === '.'\n\t\t\t\t? path.resolve(sourceMapDir, srcPath)\n\t\t\t\t: srcPath\n\t\t));\n\n\t\tlet sourceMap = new SourceMapConsumer(rawSourceMap);\n\n\t\t/* if there are inline sources and a store to put them into, we will populate it */\n\t\tconst inlineSourceMap = {};\n\t\tlet origSourceFilename;\n\t\tlet origFileName;\n\t\tlet fileName;\n\n\t\tif (sourceMap.sourcesContent) {\n\t\t\torigSourceFilename = rawSourceMap.sources[0];\n\n\t\t\tif (origSourceFilename && path.extname(origSourceFilename) !== '') {\n\t\t\t\torigFileName = rawSourceMap.file;\n\t\t\t\tfileName = filePath.replace(path.extname(origFileName), path.extname(origSourceFilename));\n\t\t\t\trawSourceMap.file = fileName;\n\t\t\t\trawSourceMap.sources = [fileName];\n\t\t\t\trawSourceMap.sourceRoot = '';\n\t\t\t\tsourceMap = new SourceMapConsumer(rawSourceMap);\n\t\t\t}\n\n\t\t\tsourceMap.sourcesContent.forEach((source, idx) => {\n\t\t\t\tinlineSourceMap[sourceMap.sources[idx]] = true;\n\t\t\t\tthis.sparceCoverageCollector.setSourceCode(\n\t\t\t\t\tsourceMap.sources[idx],\n\t\t\t\t\tcodeIsArray ? source.split('\\n') : source\n\t\t\t\t);\n\t\t\t\tif (this.sourceStore) {\n\t\t\t\t\tthis.sourceStore.set(sourceMap.sources[idx], source);\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\n\t\tconst resolvePath = (source) => {\n\t\t\tlet resolvedSource = source in inlineSourceMap\n\t\t\t\t? source\n\t\t\t\t: path.resolve(sourceMapDir, source);\n\n\t\t\tif (!this.useAbsolutePaths && !(source in inlineSourceMap)) {\n\t\t\t\tresolvedSource = path.relative(process.cwd(), resolvedSource);\n\t\t\t}\n\t\t\treturn resolvedSource;\n\t\t};\n\n\t\tconst getMappingResolved = (location) => {\n\t\t\tconst mapping = getMapping(sourceMap, location);\n\t\t\tif (!mapping) return null;\n\n\t\t\treturn Object.assign(mapping, { source: resolvePath(mapping.source) });\n\t\t};\n\n\t\tObject.keys(fileCoverage.branchMap).forEach((index) => {\n\t\t\tconst genItem = fileCoverage.branchMap[index];\n\t\t\tconst hits = fileCoverage.b[index];\n\n\t\t\tconst info = remapBranch(genItem, getMappingResolved);\n\n\t\t\tif (info) {\n\t\t\t\tthis.sparceCoverageCollector.updateBranch(info.source, info.srcItem, hits);\n\t\t\t}\n\t\t});\n\n\t\tObject.keys(fileCoverage.fnMap).forEach((index) => {\n\t\t\tconst genItem = fileCoverage.fnMap[index];\n\t\t\tconst hits = fileCoverage.f[index];\n\n\t\t\tconst info = remapFunction(genItem, getMappingResolved);\n\n\t\t\tif (info) {\n\t\t\t\tthis.sparceCoverageCollector.updateFunction(info.source, info.srcItem, hits);\n\t\t\t}\n\t\t});\n\n\t\tObject.keys(fileCoverage.statementMap).forEach((index) => {\n\t\t\tconst genItem = fileCoverage.statementMap[index];\n\t\t\tconst hits = fileCoverage.s[index];\n\n\t\t\tconst mapping = getMappingResolved(genItem);\n\n\t\t\tif (mapping) {\n\t\t\t\tthis.sparceCoverageCollector.updateStatement(mapping.source, mapping.loc, hits);\n\t\t\t}\n\t\t});\n\n\t\t// todo: refactor exposing implementation details\n\t\tconst srcCoverage = this.sparceCoverageCollector.getFinalCoverage();\n\n\t\tif (sourceMap.sourcesContent && this.basePath) {\n\t\t\t// Convert path to use base path option\n\t\t\tconst getPath = filePath => {\n\t\t\t\tconst absolutePath = path.resolve(this.basePath, filePath);\n\t\t\t\tif (!this.useAbsolutePaths) {\n\t\t\t\t\treturn path.relative(process.cwd(), absolutePath);\n\t\t\t\t}\n\t\t\t\treturn absolutePath;\n\t\t\t};\n\t\t\tconst fullSourceMapPath = getPath(\n\t\t\t\torigFileName.replace(path.extname(origFileName), path.extname(origSourceFilename))\n\t\t\t);\n\t\t\tsrcCoverage[fullSourceMapPath] = srcCoverage[fileName];\n\t\t\tsrcCoverage[fullSourceMapPath].path = fullSourceMapPath;\n\t\t\tdelete srcCoverage[fileName];\n\t\t}\n\t}\n\n\taddCoverage(item) {\n\t\tObject.keys(item)\n\t\t\t.forEach((filePath) => {\n\t\t\t\tconst fileCoverage = item[filePath];\n\t\t\t\tthis.addFileCoverage(filePath, fileCoverage);\n\t\t\t});\n\t}\n\n\tgetFinalCoverage() {\n\t\tconst collector = new Collector();\n\n\t\tconst srcCoverage = this.sparceCoverageCollector.getFinalCoverage();\n\n\t\tcollector.add(Object.keys(srcCoverage)\n\t\t\t.filter((filePath) => !this.exclude(filePath))\n\t\t\t.reduce((obj, name) => {\n\t\t\t\tobj[name] = srcCoverage[name];\n\t\t\t\treturn obj;\n\t\t\t}, {}));\n\n\t\t/* refreshes the line counts for reports */\n\t\tcollector.getFinalCoverage();\n\n\t\treturn collector;\n\t}\n}\n"]}